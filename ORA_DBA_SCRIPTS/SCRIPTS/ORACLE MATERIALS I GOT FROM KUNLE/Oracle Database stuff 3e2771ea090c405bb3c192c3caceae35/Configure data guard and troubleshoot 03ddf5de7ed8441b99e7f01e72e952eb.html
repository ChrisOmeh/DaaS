<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Configure data guard and troubleshoot</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="03ddf5de-7ed8-441b-99e7-f01e72e952eb" class="page sans"><header><h1 class="page-title">Configure data guard and troubleshoot</h1></header><div class="page-body"><p id="c16ec47e-3ed5-4482-afcb-1abc81a816ae" class="">
</p><p id="8a0489d4-d3a1-4ef7-8ebf-ac45bd2ef6ba" class="">
</p><pre id="db7a6949-3e71-4b7d-90e4-cc5ae6db2b91" class="code code-wrap"><code>-- install VMs

-install Guest additions
changed clipboard into bidirectoinal
change network from NAT to bridged adapter


-- access content of the shared  folder
sudo usermod -a -G vboxsf `whoami`
sudo chown -R `whoami`:users /media/sf_Public/


yum -y install oracle-database-preinstall-19c.x86_64

mkdir -p /u01 /u02
chown -R oracle:oinstall /u01 /u02


--disable firewall
systemctl status firewalld 
systemctl stop firewalld 

configure /etc/hosts file
172.20.10.10	primary.dg	primary
172.20.10.11	standby.dg	standby

--- change/set oracle user passwd
passwd oracle

https://www.support.dbagenesis.com/post/oracle-19c-installation-on-linux -- silent installation

https://oracle-base.com/articles/19c/data-guard-setup-using-broker-19c

--------- DATA

shutdown db and startup mount;

ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;

Enabled forced logging by issuing the following command.
ALTER DATABASE FORCE LOGGING;

-- Make sure at least one logfile is present.
ALTER SYSTEM SWITCH LOGFILE;

-- enable standby file management
alter system set standby_file_management = &#x27;AUTO&#x27;;


--- check size of log files
select GROUP#, THREAD#, bytes/1024/1024, MEMBERS, STATUS from v$log;
select member from v$logfile; -- check logfile location

alter database add standby logfile thread 1 group 11 &#x27;/u01/app/oracle/oradata/ORCL/standby_redo01.log&#x27; size 200M;
alter database add standby logfile thread 1 group 12 &#x27;/u01/app/oracle/oradata/ORCL/standby_redo02.log&#x27; size 200M;
alter database add standby logfile thread 1 group 13 &#x27;/u01/app/oracle/oradata/ORCL/standby_redo03.log&#x27; size 200M;
alter database add standby logfile thread 1 group 14 &#x27;/u01/app/oracle/oradata/ORCL/standby_redo04.log&#x27; size 200M;

-- check standby log files
SELECT GROUP#,THREAD#,SEQUENCE#,ARCHIVED,STATUS FROM V$STANDBY_LOG;

-- check db and db unique name
show parameter db_name
show parameter db_unique_name


-- create password file
orapwd file=$ORACLE_HOME/dbs/orapwd format=12
-- &#x27;format=12&#x27; is to bypass password verification
scp orapwd oracle@srv2:$ORACLE_HOME/dbs -- send it to standby

-- create static listener
-- in tnsnames.ora
-- add to both servers


orcl =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = primary)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = orcl)
    )
  )

orcl_st =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = standby)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = orcl_st)
    )
  )



-- in listener.ora on primary
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = primary)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl)
      (ORACLE_HOME = /u01/database)
      (SID_NAME = orcl)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = orcl_DGMGRL)
      (ORACLE_HOME = /u01/database)
      (SID_NAME = orcl)
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle

-- in listener.ora on standby
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = standby)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl_st)
      (ORACLE_HOME = /u01/database)
      (SID_NAME = orcl_st)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = orcl_st_DGMGRL)
      (ORACLE_HOME = /u01/database)
      (SID_NAME = orcl_st)
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle

 lsnrctl stop
 lsnrctl start



test both connections with tnsping
 
---- create password file for standby on primary and send to secondary (cd $ORACLE_HOME/dbs)
orapwd file=orapworcl_st password=qaz123wsx
scp orapwd oracle@srv2:$ORACLE_HOME/dbs -- send it to standby

alter user sys identified by wsx234_edc; -- password changed on 07nov2021
orapwd file=orapworcl password=wsx234_edc format=12.2;
orapwd file=orapworcl_st password=wsx234_edc format=12.2;
/*
file parameter is just the filename (must be in the appropriate directory)
must also start with prefix &#x27;orapw&#x27; 
recommended suffix is the standby sid name
password is the password for the sys user
*/


----------------------------------CONFIGURE REDO TRANSPORT
---- configure redo transport (on primary)
alter system set log_archive_dest_2 = &#x27;service=orcl_st async valid_for=(online_logfiles,primary_role) db_unique_name=orcl_st&#x27;;

-- configure FAL(Fectch Archive Log) parameter incase there is a gap
alter system set fal_server=&#x27;orcl_st&#x27;; -- on primary
--alter system set fal_server=&#x27;orcl&#x27;; -- standby ( just edit on the pfile )

-- config SIDs combined to setup data guard
alter system set log_archive_config = &#x27;dg_config=(orcl,orcl_st)&#x27;; -- on primary


------ setting up standby db
1. create pfile from spfile on primary
2. edit pfile for secondary (change those parameters that point to standby from primary to the othr way round)
3. create spfile from the edited pfile  

create pfile=&#x27;/tmp/initorcl_s.ora&#x27; from spfile;

change following parametes
fal_server
log_archive_dest_2
add db_unique_name (orcl_st)

make directories for every directory seen in pfile
 
create spfile from pfile=&#x27;/tmp/initorcl_st.ora&#x27;;

--------
startup nomount;

show parameter spfile --- check if it started with the spfile as intended.

exit;  ---- must exit from the instance so rman can do his work.


----- using RMAN duplicate (RUN ON PRIMARY)
/*
ensure you do not use &#x27;/&#x27; with rman, cloning will fail
eg rman target / as sysdba;
use &#x27;rman target sys/{ORCL_SID};
*/

rman target sys@orcl;

-- connect auxiliary or catalog ( if you have catalog) 

connect auxiliary sys@orcl_st; -- ensure you use the same sys password

duplicate target database for standby from active database nofilenamecheck; -- from the auxiliary connection.

/*
Log shipping service has automatically started
Log apply service (MRP) has to be started on the standby
*/

_______________VERIFY STANDBY CONFIG

-- start MRP (on standby)
alter database recover managed standby database disconnect; /*disconnect is to make sure it runs in the background*/

On both primary &amp; standby:
==========================
set lines 999;
select * from v$dataguard_status order by timestamp;

select dest_id, status, destination, error from v$archive_dest where dest_id&lt;=2;  -- check if everything is VALID

IF you see any ORA error like ORA-16058, do this on primary:
============================================================
SQL&gt; alter system set log_archive_dest_state_2=&#x27;DEFER&#x27;;
SQL&gt; alter system set log_archive_dest_state_2=&#x27;ENABLE&#x27;;
SQL&gt; select dest_id, status, destination, error from v$archive_dest where dest_id&lt;=2;

On primary:
===========
select sequence#, first_time, next_time, applied, archived from v$archived_log where name = &#x27;orcl_st&#x27; order by first_time;

select STATUS, GAP_STATUS from V$ARCHIVE_DEST_STATUS where DEST_ID = 2;
archive log list;

On standby:
===========
select process, status, sequence# from v$managed_standby; --- check if MRP is running

select sequence#, applied, first_time, next_time, name filename from v$archived_log order by sequence#; --check locatoin of archive log file and if it has been applied. Also shows name of log file.


-------- FLASHBACK (IF YOU NEED IT)
alter database recover managed standby database cancel; -- stop MRP

alter database flashback on; -- enable flashback

alter database recover managed standby database disconnect; restart MRP



-------- CONFIGURE ARCHIVE DELETION POLICY (We must set this policy in order to prevent accidental deletion of archive logs on primary database before it has been sent)

On Primary:
===========
rman target / --connect to RMAN

configure archivelog deletion policy to applied on all standby;



---------------------- REDO TRANSPORT MODES
1. Archive Transport - shipping from archive log files (ASYNC). { alter system set log_archive_dest_2 = &#x27;service=orcl_st async valid_for=(online_logfiles,primary_role) db_unique_name=orcl_st&#x27;; }
2. Redo log file transport - shipping from online redo log files (LGWR ASYNC) (preferrable) { alter system set log_archive_dest_2 = &#x27;service=orcl_st lgwr async valid_for=(online_logfiles,primary_role) db_unique_name=orcl_st&#x27;; }
3. Redo entry transport - shipping from redo log buffer (LGWR SYNC). This is the max protection mode { alter system set log_archive_dest_2 = &#x27;service=orcl_st lgwr sync valid_for=(online_logfiles,primary_role) db_unique_name=orcl_st&#x27;; }

NB: LNS comes in Redo log file transport and Redo entry transport while archive transport is archival shipping...... (verify this)




-------------------------------- CLIENT CONNECTIVITY 
On Primary:
===========

--step 1: create service
exec DBMS_SERVICE.CREATE_SERVICE(service_name =&gt; &#x27;client_con&#x27;, network_name =&gt; &#x27;client_con&#x27;, failover_method =&gt; &#x27;BASIC&#x27;, failover_type =&gt; &#x27;SELECT&#x27;, failover_retries =&gt; 30, failover_delay =&gt; 10);


-- choose service_name and network_name of your choice
-- failover_delay is the time taken before new retries
-- failover_retries is the amount of time a select query will retry before it eventually fails in the event of a failover.

/*If you create on the primary, it will be automatically created on the standby on log shipping. To expedite this, switch the log file (alter system switch logfile;)*/

--step 2: create procedure
create or replace procedure start_client_con_service
is
v_role VARCHAR(30);
begin
select DATABASE_ROLE into v_role from V$DATABASE; -- get database role. if role is primary, start service &#x27;client_con&#x27; else stop the service.
if v_role = &#x27;PRIMARY&#x27; then
exec DBMS_SERVICE.START_SERVICE(&#x27;client_con&#x27;);
else
exec DBMS_SERVICE.STOP_SERVICE(&#x27;client_con&#x27;);
end if;
end;

--step 3: create trigger (We need to create trigger to start above service on database startup and also role change on primary)

TRIGGER TO START SERVICE ON DB STARTUP:
=======================================
create or replace TRIGGER start_client_con_on_startup
after startup on database
begin
start_client_con_service;
end;

TRIGGER TO START SERVICE ON DB ROLECHANGE:
==========================================
create or replace TRIGGER start_client_con_on_role_change
after db_role_change on database
begin
start_client_con_service;
end;

--step 4:Start the new service
exec start_client_con_service;
alter system archive log current;
alter system switch logfile;

--step 5: create or edit tnsnames.ora file on the client
orcl =
  (DESCRIPTION =
    (ADDRESS_LIST=
      (ADDRESS = (PROTOCOL = TCP)(HOST = primary)(PORT = 1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = standby)(PORT = 1521))
    )
   (CONNECT_DATA = (SERVICE_NAME = client_con)
     (FAILOVER_MODE=(TYPE=SELECT)(METHOD=BASIC)(RETRIES=30)(DELAY=10))
   )
  )
  
  
-------------------------------- MANUAL SWITCHOVER
1. ensure there is no gap

select name, open_mode, db_unique_name, database_role from v$database;
select STATUS, GAP_STATUS from V$ARCHIVE_DEST_STATUS where DEST_ID = 2; -- check if theres a gap (run on primary)

select NAME, VALUE, DATUM_TIME from V$DATAGUARD_STATS; (run on standby)

select SWITCHOVER_STATUS from V$DATABASE; (run on primary)



2. convert primary to standby
	
	ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL STANDBY WITH SESSION SHUTDOWN;
	STARTUP MOUNT;
	
3. convert standby to primary
	select SWITCHOVER_STATUS from V$DATABASE;
	
	ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WITH SESSION SHUTDOWN;
	ALTER DATABASE OPEN;
	
4. start MRP on new standby  (former primary)
	
	ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;


  
----------------------------------------------- MANUAL FAILOVER
on standby
==========

alter database recover managed standby database cancel; -- stop mrp

alter database recover managed standby database finish; --- finish mrp and force standby switchover status to be &#x27;to primary&#x27;

select switchover_status from v$database; -- must show &#x27;to primary&#x27;

alter database commit to switchover to primary wiht session shutdown; -- perform switchover

alter database open; -- open database and enjoy
  
  
  

----- EXTRAS
in shutting down the dataguard config ensure you shut the MRP process first before shutting down the standby db then finally the primary db.


---------------------MISC
CREATE PLUGGABLE DATABASE pdbts 
    ADMIN USER pdbtsadmin IDENTIFIED BY pdbtsadmin ROLES = ( dba )
    DEFAULT TABLESPACE users 
    DATAFILE &#x27;/u01/app/oracle/oradata/ORCL/pdbts/users01.dbf&#x27; SIZE 250M AUTOEXTEND ON
    FILE_NAME_CONVERT = ( &#x27;/u01/app/oracle/oradata/ORCL/pdbseed/&#x27;, &#x27;/u01/app/oracle/oradata/ORCL/pdbts/&#x27; )



insert into employees values(1, &#x27;John Doe 1&#x27;);</code></pre></div></article></body></html>